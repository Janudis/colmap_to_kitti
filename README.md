# 3D Reconstruction and KITTI Calibration Generation

This repository demonstrates how to:
1. Reconstruct a 3D model (mesh + sparse/dense point clouds) of an object (in this example, a motorcycle) using [COLMAP](https://colmap.github.io/).
2. Generate calibration files in [KITTI](http://www.cvlibs.net/datasets/kitti/) format.
3. Validate the generated calibration by projecting 3D points onto the original images.

---

## Table of Contents
- [Overview](#overview)
- [Project Structure](#project-structure)
- [Dependencies and Installation](#dependencies-and-installation)
- [Usage](#usage)
  - [1. Run COLMAP for Reconstruction](#1-run-colmap-for-reconstruction)
  - [2. Prepare the Project Folder](#2-prepare-the-project-folder)
  - [3. Run the Calibration Script](#3-run-the-calibration-script)
- [Script Explanation](#script-explanation)
- [Outputs](#outputs)
- [Notes and Tips](#notes-and-tips)
- [License](#license)

---

## Overview
This project uses COLMAP to perform a 3D reconstruction (sparse and dense) from a set of images. Once the reconstruction is done, we read COLMAP’s output (camera models, poses, and point clouds) and create:
- **Projected images**: Visualizing the 3D points projected onto each original image.
- **Calibration files in KITTI format**: Specifically, the intrinsic and extrinsic parameters are formatted according to KITTI standards.

---

## Project Structure
Below is the typical structure of this repository:

github_script/ ├── calib/ │ └── ... (KITTI calibration files generated by the script) ├── calibration_from_colmap.py # The main script for generating calibration + projecting points ├── colmap_output/ │ ├── sparse/ │ │ └── 0/ │ │ ├── cameras.bin │ │ ├── images.bin │ │ └── points3D.bin │ └── dense/ │ ├── fused.ply │ └── processed_fused.ply # Example dense point cloud ├── images/ │ └── ... (input images used for reconstruction) ├── projected_images_sfm/ │ └── ... (images with projected 3D points, generated by the script) └── readme.md # This file


**Note:**  
- The `sparse/0/` folder contains COLMAP’s binary model files (`cameras.bin`, `images.bin`, and `points3D.bin`).  
- The `dense/` folder contains the dense point cloud (`fused.ply` or `processed_fused.ply`).  
- `images/` must contain the exact same images used by COLMAP.  
- `calib/` and `projected_images_sfm/` are output directories created by the script.

---

## Dependencies and Installation

1. **COLMAP** (for the 3D reconstruction).  
   - [Official Installation Instructions](https://colmap.github.io/install.html)

2. **Python** (3.6+ recommended).
3. **Python packages**:
   - `numpy`
   - `opencv-python` (as `cv2`)
   - `open3d`
   - `matplotlib`
   - `trimesh` (optional if you want to handle mesh objects)
   - (Optional) `pickle` (part of the Python standard library)
   
   You can install the required Python packages via:
   ```bash
   pip install -r requirements.txt

or individually:

pip install numpy opencv-python open3d matplotlib trimesh

    COLMAP Python scripts:
        Make sure you can import the read_write_model from COLMAP.
        By default, the script in this repository uses:

        sys.path.append('/media/harddrive/colmap/scripts/python')
        from read_write_model import read_model, qvec2rotmat

        Update the sys.path.append(...) line if your COLMAP Python scripts are located elsewhere.

Usage
1. Run COLMAP for Reconstruction

    Collect your images of the object and place them in the images/ directory.

    Use COLMAP to create a new project and run:
        Feature extraction
        Feature matching
        Sparse reconstruction
        Dense reconstruction

    This will generate the sparse/0/ folder with .bin files, and dense/ folder with .ply files in colmap_output/.

2. Prepare the Project Folder

    Ensure you have the following structure:

    colmap_output
    ├── sparse
    │   └── 0
    └── dense
        └── processed_fused.ply (or fused.ply)

    images/

    The script reads from colmap_output/sparse/0/ and colmap_output/dense/processed_fused.ply by default.

    If your files differ, update the paths inside calibration_from_colmap.py.

3. Run the Calibration Script

    Navigate to the folder containing calibration_from_colmap.py (e.g., github_script/):

    cd /path/to/github_script
    python calibration_from_colmap.py

    The script will:
        Read the COLMAP output data (camera params, extrinsics, point cloud).
        Project 3D points onto each image and save them in projected_images_sfm/.
        Write KITTI-format calibration files into the calib/ directory.

Script Explanation

    Imports:
        Loads necessary libraries: numpy, cv2, open3d, matplotlib, etc.
        Imports read_model and qvec2rotmat from COLMAP’s read_write_model.

    Reading the Model and Point Cloud:

cameras, images, _ = read_model(path=model_path, ext='.bin')
pcd = o3d.io.read_point_cloud('processed_fused.ply')
points3D_xyz = np.asarray(pcd.points)

Intrinsic and Distortion Coefficients:

    Derives the camera intrinsics (K) based on the camera model (PINHOLE, SIMPLE_RADIAL, etc.).
    Handles distortion if present.

Extrinsics (R, t):

    R = qvec2rotmat(image.qvec)
    t = image.tvec.reshape(3, 1)

    Projection:
        Transforms 3D points from world coordinates to camera coordinates.
        Applies any radial distortion correction.
        Converts to 2D pixel coordinates.
        Filters out points behind the camera or outside the image bounds.

    Visualization & Saving:
        Uses matplotlib to overlay red points on the original images.
        Saves the overlay images in projected_images_sfm/.

    KITTI Calibration:
        For each image, writes P2, P0, P1, P3, R0_rect, Tr_velo_to_cam, Tr_imu_to_velo to a .txt file in the calib/ folder.
        The intrinsics are placed in P2; the rest are zeros or identity values for demonstration.

Outputs

After running the script, you should find:

    Projected Images:
        In projected_images_sfm/.
        Each image has red dots representing the reprojected 3D points.

    Calibration Files:
        In calib/ directory, named with zero-padded indexes (e.g., 000000.txt, 000001.txt, etc.).
        They follow the KITTI format structure, where P2 includes the intrinsic camera matrix.

Notes and Tips

    Accuracy of reprojected points depends on:
        How well the images were captured (lighting, motion blur, etc.).
        The effectiveness of the COLMAP reconstruction.
        The correctness of the camera model and distortion parameters.

    If you have multiple cameras or a stereo setup, you would repeat or adapt these steps accordingly.

    Further Extensions:
        Adjust the script to write more realistic extrinsic parameters in the KITTI format.
        Incorporate transformations (e.g., Tr_velo_to_cam) if you plan to integrate with LiDAR or IMU data.

